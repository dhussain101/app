#!/usr/bin/env bash

# Search for Dockerfile...
if ! ls | grep Dockerfile >/dev/null; then
	cd ..
	if ! ls | grep Dockerfile>/dev/null; then
		echo 'Please run from the project'"'"'s root directory!'
		echo 'ğŸš«  Cannot find Dockerfile, aborting'
		exit 1
	fi
fi

# And search for docker-compose.yml
if ! ls | grep docker-compose.yml>/dev/null; then
	echo 'ğŸš«  Cannot find docker-compose.yml, aborting'
	exit 1
fi

bin/start-db
echo

# Check if custom container is running
if [[ -n "$(docker ps -q -f name=djangorest -f status=running 2>/dev/null)" ]]; then
	echo 'âš ï¸  It looks like you'"'"'re already running the djangorest container.'
	read -r -p 'Would you like to restart djangorest? [y/N] ' response
	if [[ "$response" == 'y' || "$response" == 'Y' ]]; then
		docker-compose down
		echo
	else
		unset response
		exit
	fi
fi

declare -A container_builds=( ["djangorest"]="Dockerfile" ["hauptmedia/jmeter"]="Dockerfile_jmeter")


for container in "${!container_builds[@]}"
do
	# Check if container is up to date:
	# - Doesn't exist
	# - Never ran diff before
	# - On new branch since last run
	# - Dockerfile was changed since last run
	if [[ -z "$(docker images -q $container 2>/dev/null)" || \
		! -s .previouscommit || \
		"$(md5 -q ${container_builds[$container]})" != "$(cat .previouscommit)" ]]; then
		echo "ğŸ›   Building $container"
		echo 'â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”'
		docker build -t "$container" -f "${container_builds[$container]}" .
	else
		echo 'â©  Skipping build'
		rm -f .previouscommit
	fi
done

md5 -q Dockerfile > .previouscommit

# Container is not running yet, so start it
echo
echo 'âš“ï¸  Composing'
echo 'â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”'
docker-compose up

unset response
